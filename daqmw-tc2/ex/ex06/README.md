(テーマ)ファイルを読んでデコード
================================

ローデータをデコードできるようにする。


実習内容
--------

実習に使うボードからとったデータをデコードするルーチンを書く。
できたデコードプログラムは最終的にDAQ-Middlewareコンポーネントに
組み込むことになる。

データフォーマット
------------------

まずデータフォーマットをしらなければならない。
データフォーマットは ~/daqmw-tc/doc/raw-data-packet-format.pdf にある。
Linux上でPDFファイルを読むにはevinceプログラムを使う:

    % evince ~/daqmw-tc/doc/raw-data-packet-format.pdf

ヘッダ部と、データ部にわかれている。
ヘッダ部の長さは12バイトで固定である。このなかに次に続くデータ部の
長さが書いてある(バイトを単位)。その他ヘッダには

* データタイプ(0xf) (他のデータパケットと見分けるのが目的)
* Word length (2) (1トリガ1チャンネル1ウインドウデータのバイトサイズ)
* number of Ch (16) (チャンネル数)
* データ長
* トリガーカウント (0が最初。トリガーがかかるごとに1づつ増える)

の情報が入っている。複数バイトで構成される数値はいずれも
ネットワークバイトオーダになっているので、PCで扱うには変換が必要になる。

word lengthとチャンネル数とデータ長から、何ウインドウ分のデータが
入っているのかがわかる:

     ウインドウ数 = データ長 / ((word length)*(チャンネル数))

データの部分は16ビットであるが、上位4ビットはチャンネル番号を表す。
のこり12ビットがデータとなる。

     15             8|7             0
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | | | | | | | | | | | | | | | | |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
             |       |
     <-------><---------------------->
       CH #         ADC  Data

行う作業内容
------------

プログラムは ~/daqmw-tc/ex/ex06/ にあるのでこれをコピーして
使う:

    % cd ~/daqmw-tc/sandbox
    % cp -r ../ex/ex06 .

デコード部分のメソッドが書いてないのでこれを埋めること。

サンプルデータは ~/daqmw-tc/bs/sample.dat にある。
このファイルのデータ部をデコードして

    trg: XXX ch: XXX window: XXX data: XXX

と並べたものを ~/daqmw-tc/bs/ascii.sample としておいてあるので
自分で書いたプログラムでOKかどうかはこれと同じフォーマットで
出力するようにして比較することで可能である。
比較にはたとえばdiffプログラムを使うと機械的にできる。

    % diff -u file_a file_b

違いがなければなにも出力されない。

ファイル

* Makefile
* RawDataPacket.h     デコードルーチンクラスファイル
* RawDataPacket.cpp   デコードルーチンクラス実装(各メソッドが書いてないので埋める)
* read_file_decode.cpp fread()を使ってファイルを読む(このなかでRawDataPacketで実装したメソッドを使っている。main()はこのなかにある)。

実装するメソッド(ヘッダデータを読むところ)

* is_raw_data_packet()
* get_word_size()
* get_data_length()
* get_num_of_ch()
* get_window_size()

get_window_size()はデータ長/(ワードサイズ*チャンネル数)で求めたwindow数を返すこと。

データ部を読むところ

* get_data_at(int ch, int window)

データ部はwindowごとにまとまっていてひとつのチャンネルのデータが連続している
わけではない。デコードする際にはチャンネルごとのデータがほしいことが多いかと
思うので、引数にチャンネル番号、windowを指定することにした。

解答例
------

各メソッドを実装したものを ~/daqmw-tc/bs/read_file_decode/ においてある。
